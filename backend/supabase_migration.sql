-- =====================================================
-- SUPABASE MIGRATION: LabelCheck UA Database Schema
-- =====================================================
-- Створення 3 основних таблиць для системи перевірки етикеток
-- Автор: LabelCheck UA Team
-- Дата: 2025-01-22
-- Версія: 1.0

-- =====================================================
-- ТАБЛИЦЯ 1: mandatory_fields
-- =====================================================
-- Обов'язкові поля на етикетці дієтичної добавки

CREATE TABLE mandatory_fields (
    id SERIAL PRIMARY KEY,
    field_name VARCHAR(200) NOT NULL UNIQUE,
    field_name_ua VARCHAR(200) NOT NULL,
    description TEXT,
    regulatory_source VARCHAR(500),
    article_number VARCHAR(100),
    criticality VARCHAR(20) CHECK (criticality IN ('critical', 'warning', 'recommendation')),
    error_message TEXT,
    recommendation TEXT,
    penalty_amount INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Індекс для швидкого пошуку
CREATE INDEX idx_mandatory_fields_criticality ON mandatory_fields(criticality);

-- =====================================================
-- ТАБЛИЦЯ 2: forbidden_phrases
-- =====================================================
-- Заборонені формулювання на етикетках

CREATE TABLE forbidden_phrases (
    id SERIAL PRIMARY KEY,
    phrase TEXT NOT NULL,
    phrase_variations TEXT[], -- варіації фрази (синоніми)
    category VARCHAR(100), -- 'disease', 'treatment', 'medical', 'diagnosis'
    regulatory_source VARCHAR(500),
    explanation TEXT,
    severity VARCHAR(20) CHECK (severity IN ('critical', 'high', 'medium')),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Індекси для пошуку
CREATE INDEX idx_forbidden_phrases_category ON forbidden_phrases(category);
CREATE INDEX idx_forbidden_phrases_phrase ON forbidden_phrases USING gin(to_tsvector('ukrainian', phrase));

-- =====================================================
-- ТАБЛИЦЯ 3: regulatory_acts
-- =====================================================
-- Нормативні акти України

CREATE TABLE regulatory_acts (
    id SERIAL PRIMARY KEY,
    act_number VARCHAR(100) NOT NULL UNIQUE,
    act_type VARCHAR(50) CHECK (act_type IN ('law', 'decree', 'order', 'regulation')),
    title TEXT NOT NULL,
    date_adopted DATE,
    date_effective DATE,
    date_enforcement DATE,
    status VARCHAR(20) CHECK (status IN ('active', 'draft', 'cancelled')) DEFAULT 'active',
    full_text_url VARCHAR(500),
    summary TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Індекс
CREATE INDEX idx_regulatory_acts_status ON regulatory_acts(status);

-- =====================================================
-- ДАНІ ДЛЯ ЗАВАНТАЖЕННЯ
-- =====================================================

-- Обов'язкові поля (18 записів)
INSERT INTO mandatory_fields (field_name, field_name_ua, description, regulatory_source, article_number, criticality, error_message, recommendation, penalty_amount) VALUES
('product_name_label', 'Назва "ДІЄТИЧНА ДОБАВКА"', 'Обов''язкова назва категорії товару', 'Наказ МОЗ №1114, п.3.1', 'п.3.1', 'critical', 'Відсутня обов''язкова назва "ДІЄТИЧНА ДОБАВКА"', 'Додайте текст "ДІЄТИЧНА ДОБАВКА" на початку етикетки великими літерами', 640000),

('edrpou_code', 'Код ЄДРПОУ оператора ринку', 'Код ЄДРПОУ або РНОКПП для ФОП', 'Закон №2639-VIII, ст.6, п.8', 'ст.6, п.8', 'critical', 'Відсутній код ЄДРПОУ або РНОКПП', 'Додайте "Код ЄДРПОУ: [ваш код]" після назви оператора ринку', 640000),

('operator_full_name', 'Повна назва оператора ринку', 'Юридична назва компанії або ПІБ ФОП', 'Закон №2639-VIII, ст.6', 'ст.6', 'critical', 'Відсутня назва відповідальної особи/оператора ринку', 'Вкажіть повну назву: ТОВ "[Назва]" або ФОП "[ПІБ]"', 640000),

('operator_address', 'Адреса оператора ринку', 'Повна юридична адреса з індексом', 'Закон №2639-VIII, ст.6', 'ст.6', 'critical', 'Відсутня адреса оператора ринку', 'Вкажіть: індекс, область, місто, вулиця, будинок', 640000),

('composition', 'Склад продукту', 'Перелік всіх інгредієнтів з кількістю', 'Закон №2639-VIII, ст.6; Наказ №1114, п.3.1', 'ст.6; п.3.1', 'critical', 'Відсутній детальний склад продукту', 'Вкажіть всі активні та допоміжні речовини з кількістю', 640000),

('recommended_dose', 'Рекомендована добова доза', 'Кількість для щоденного споживання', 'Наказ МОЗ №1114, п.3.1', 'п.3.1', 'critical', 'Відсутня рекомендована добова доза', 'Вкажіть: "Дорослим по [X] таблеток/капсул на день"', 640000),

('do_not_exceed_warning', 'Попередження про недопущення перевищення', 'Обов''язкове застереження про дозу', 'Наказ МОЗ №1114, п.3.1', 'п.3.1', 'critical', 'Відсутнє попередження про недопущення перевищення дози', 'Додайте: "Не перевищувати вказану рекомендовану добову дозу для щоденного споживання"', 640000),

('not_substitute_warning', 'Застереження "Не заміняє раціон"', 'Про те що БАД не замінює їжу', 'Наказ МОЗ №1114, п.3.1', 'п.3.1', 'critical', 'Відсутнє застереження про незаміну раціону харчування', 'Додайте: "Дієтичні добавки не слід використовувати як заміну повноцінного раціону харчування"', 640000),

('keep_away_children', 'Застереження "Зберігати від дітей"', 'Обов''язкове застереження про зберігання', 'Наказ МОЗ №1114, п.3.1', 'п.3.1', 'critical', 'Відсутнє застереження про зберігання в недоступному для дітей місці', 'Додайте: "Зберігати в недоступному для дітей місці"', 640000),

('expiry_date', 'Термін придатності', 'Дата або строк придатності', 'Закон №2639-VIII, ст.6', 'ст.6', 'critical', 'Відсутній термін придатності', 'Вкажіть: "Термін придатності: [X] років" або "Вжити до: [дата]"', 640000),

('storage_conditions', 'Умови зберігання', 'Температура, вологість, світло', 'Закон №2639-VIII, ст.6', 'ст.6', 'warning', 'Відсутні умови зберігання', 'Вкажіть: температурний режим, вологість, захист від світла', 62600),

('net_quantity', 'Чиста кількість продукту', 'Кількість одиниць в упаковці', 'Закон №2639-VIII, ст.6', 'ст.6', 'critical', 'Відсутня інформація про кількість продукту', 'Вкажіть: "[X] таблеток" або "[X] капсул" або "[X] г"', 640000),

('batch_number', 'Номер партії', 'Для простежуваності продукції', 'Закон №771/97-ВР, ст.22', 'ст.22', 'critical', 'Відсутній номер партії', 'Додайте: "Номер партії: [XXX]" або "Партія співпадає з датою виробництва"', 640000),

('not_medicine', 'Застереження "Не є лікарським засобом"', 'Розмежування з ліками', 'Практика ринку, рекомендовано', NULL, 'recommendation', 'Відсутнє застереження "Не є лікарським засобом"', 'Додайте: "Не є лікарським засобом"', NULL),

('allergen_info', 'Інформація про алергени', 'Виділені шрифтом або кольором', 'Закон №2639-VIII, ст.15', 'ст.15', 'critical', 'Алергени не виділені або відсутні', 'Виділіть алергени жирним шрифтом або іншим кольором', 125200),

('country_origin', 'Країна походження', 'Обов''язково для імпортних товарів', 'Закон №2639-VIII, ст.6', 'ст.6', 'warning', 'Відсутня країна походження (для імпорту)', 'Вкажіть: "Країна походження: [Назва країни]"', 62600),

('tu_specification', 'Технічні умови (ТУ У)', 'Технічна специфікація виробництва', 'Практика ринку, рекомендовано', NULL, 'recommendation', 'Відсутні технічні умови ТУ У', 'Додайте: "ТУ У [номер]"', NULL),

('manufacturer_info', 'Інформація про виробника', 'Назва та адреса виробника', 'Закон №2639-VIII, ст.6', 'ст.6', 'warning', 'Відсутня інформація про виробника', 'Вкажіть назву та адресу виробника', 62600);

-- Заборонені фрази (15 основних записів)
INSERT INTO forbidden_phrases (phrase, phrase_variations, category, regulatory_source, explanation, severity) VALUES
('лікує', ARRAY['вилікує', 'зцілює', 'вилічує', 'лікування'], 'treatment', 'Наказ МОЗ №1114, п.3.2-3.4', 'Заборонено приписувати дієтичним добавкам властивості лікування захворювань', 'critical'),

('діагностика', ARRAY['діагностує', 'виявляє захворювання', 'діагностичний'], 'diagnosis', 'Наказ МОЗ №1114, п.3.2-3.4', 'Заборонено використовувати медичну термінологію пов''язану з діагностикою', 'critical'),

('терапія', ARRAY['терапевтичний', 'лікувальна терапія'], 'treatment', 'Наказ МОЗ №1114, п.3.2-3.4', 'Заборонено позиціонувати як терапевтичний засіб', 'critical'),

('запобігає', ARRAY['профілактика', 'попереджає', 'захищає від хвороб'], 'treatment', 'Наказ МОЗ №1114, п.3.2-3.4', 'Заборонено стверджувати про запобігання захворюванням', 'critical'),

('діабет', ARRAY['цукровий діабет', 'діабетичний', 'при діабеті'], 'disease', 'Наказ МОЗ №1114, п.3.3', 'Заборонено згадувати конкретні захворювання', 'critical'),

('рак', ARRAY['онкологія', 'пухлина', 'онкологічний', 'протираковий'], 'disease', 'Наказ МОЗ №1114, п.3.3', 'Заборонено згадувати онкологічні захворювання', 'critical'),

('гіпертонія', ARRAY['високий тиск', 'артеріальна гіпертензія', 'при гіпертонії'], 'disease', 'Наказ МОЗ №1114, п.3.3', 'Заборонено згадувати серцево-судинні захворювання', 'critical'),

('артрит', ARRAY['артроз', 'при артриті', 'ревматизм'], 'disease', 'Наказ МОЗ №1114, п.3.3', 'Заборонено згадувати захворювання суглобів', 'critical'),

('депресія', ARRAY['при депресії', 'антидепресант', 'лікує депресію'], 'disease', 'Наказ МОЗ №1114, п.3.3', 'Заборонено згадувати психічні розлади', 'critical'),

('втамування болю', ARRAY['знеболююче', 'зняття болю', 'проти болю'], 'treatment', 'Наказ МОЗ №1114, п.3.3 (нова редакція)', 'Заборонено стверджувати про втамування болю', 'critical'),

('замінює ліки', ARRAY['краще за ліки', 'природний аналог ліків', 'замість ліків'], 'medical', 'Наказ МОЗ №1114, п.3.2-3.4', 'Заборонено позиціонувати як заміну лікарським засобам', 'critical'),

('холестерин', ARRAY['знижує холестерин', 'при холестерині', 'проти холестерину'], 'disease', 'Наказ МОЗ №1114, п.3.3', 'Допускається тільки загальне формулювання про підтримку серця', 'high'),

('імунітет', ARRAY['підвищує імунітет', 'зміцнює імунітет', 'для імунітету'], 'treatment', 'Наказ МОЗ №1114, п.3.3', 'Допускається "підтримує нормальну роботу імунної системи"', 'medium'),

('схуднення', ARRAY['для схуднення', 'спалює жир', 'зменшує вагу'], 'treatment', 'Наказ МОЗ №1114, п.3.3', 'Заборонено стверджувати про гарантоване схуднення', 'high'),

('клінічно доведено лікує', ARRAY['клінічні дослідження довели лікування', 'доведена лікувальна дія'], 'treatment', 'Наказ МОЗ №1114, п.3.2-3.4', 'Заборонено стверджувати про клінічно доведене лікування', 'critical');

-- Нормативні акти (5 записів)
INSERT INTO regulatory_acts (act_number, act_type, title, date_adopted, date_effective, date_enforcement, status, full_text_url, summary) VALUES
('4122-IX', 'law', 'Про внесення змін до деяких законів України щодо удосконалення регулювання виробництва та обігу дієтичних добавок', '2024-12-05', '2025-03-27', '2025-09-27', 'active', 'https://zakon.rada.gov.ua/go/4122-20', 'Новий закон про дієтичні добавки. Введення повідомної системи, нові вимоги до маркування, штрафи до 640,000 грн'),

('2639-VIII', 'law', 'Про інформацію для споживачів щодо харчових продуктів', '2018-12-06', '2019-08-06', NULL, 'active', 'https://zakon.rada.gov.ua/laws/show/2639-19', 'Основний закон про маркування харчових продуктів (включно з БАДами). 18 обов''язкових пунктів інформації, розмір шрифту 1.2мм, алергени'),

('771/97-ВР', 'law', 'Про основні принципи та вимоги до безпечності та якості харчових продуктів', '1997-12-23', '1998-01-01', '2025-09-27', 'active', 'https://zakon.rada.gov.ua/laws/show/771/97', 'Базовий закон про безпечність харчових продуктів. Оновлене визначення дієтичної добавки (після змін від Закону №4122-IX)'),

('1114', 'order', 'Про затвердження Гігієнічних вимог до дієтичних добавок', '2013-12-19', '2016-01-24', NULL, 'active', 'https://zakon.rada.gov.ua/laws/show/z2231-13', 'Наказ МОЗ з детальними вимогами до складу, маркування та реклами БАДів. Додатки 1-3 з переліками дозволених речовин. Очікуються зміни у 2025 р.'),

('270/96-ВР', 'law', 'Про рекламу', '1996-07-03', '1996-08-01', NULL, 'active', 'https://zakon.rada.gov.ua/laws/show/270/96', 'Закон про рекламу. Заборонено приписувати БАДам властивості лікарських засобів, згадувати лікування/діагностику');

-- =====================================================
-- КІНЕЦЬ МІГРАЦІЇ
-- =====================================================
-- Створено: 3 таблиці, 18 обов'язкових полів, 15 заборонених фраз, 5 нормативних актів
-- Готово до використання в LabelCheck UA системі
